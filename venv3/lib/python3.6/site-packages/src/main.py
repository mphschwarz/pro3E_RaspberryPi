import time
import click

import src.archive
import src.input
import src.output

cache_length = 100

@click.command()
@click.option('--data_base', type=str, help='database to be extended')
@click.option('--plot_path', type=click.Path(exists=True), help='directory for plots')
@click.option('--out_path', type=click.Path(exists=True), help='directory for html files')
def main(data_base, plot_path='.', out_path='.'):
    cache = []
    device = src.input.init_devs()
    data_base = open(str(data_base), 'a')
    while True:
        t_start = time.time()
        cache.append(src.input.request_data(device))
        print(str(cache[-1]))
        if len(cache) > cache_length:
            data_base.write(cache.pop())
            data_base.write('\n')
        src.output.make_plot(plot_path, cache)
        src.output.make_html(out_path, cache)
        time.sleep(time.time() - t_start)

if __name__ == '__main__':
    main()
